name: Create package-lock.json (patch stremio-sdk)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-lockfile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate package.json exists
        run: |
          if [ ! -f package.json ]; then
            echo "ERROR: package.json not found in repo root. Aborting."
            ls -la
            exit 1
          fi
          echo "package.json found"

      - name: Patch stremio-addon-sdk to a resolvable version
        id: patch
        run: |
          # If package.json has a stremio-addon-sdk entry with an unreachable version,
          # replace its version with "latest" so install can proceed.
          python3 - <<'PY'
import json,sys
p='package.json'
with open(p,'r',encoding='utf-8') as f:
    data=json.load(f)
deps = data.get('dependencies') or {}
changed=False
if 'stremio-addon-sdk' in deps and deps['stremio-addon-sdk'] != 'latest':
    deps['stremio-addon-sdk']='latest'
    data['dependencies']=deps
    changed=True
    with open(p,'w',encoding='utf-8') as w:
        json.dump(data,w,indent=2,ensure_ascii=False)
print('changed' if changed else 'unchanged')
PY
          echo "patched=$?"

      - name: Show package.json changes (if any)
        run: |
          git --no-pager diff -- package.json || true

      - name: Ensure clean state and generate package-lock only
        run: |
          rm -f package-lock.json npm-shrinkwrap.json yarn.lock || true
          set -o pipefail
          npm --version
          node --version
          echo "Running npm install --package-lock-only"
          npm install --package-lock-only --no-audit --no-fund 2>&1 | tee npm-install.log || ( tail -n 200 npm-install.log ; exit 1 )
          echo "Lockfile generation finished"

      - name: Show produced lockfile
        run: |
          echo "Lockfiles in repo root:"
          ls -la package-lock.json npm-shrinkwrap.json yarn.lock || true
          echo "Preview package-lock head:"
          head -n 40 package-lock.json || true

      - name: Commit patched package.json (if changed) and package-lock.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Stage changes if present
          CHANGED=false
          if git status --porcelain | grep -q 'package.json'; then
            git add package.json
            CHANGED=true
          fi
          if [ -f package-lock.json ]; then
            git add package-lock.json
            CHANGED=true
          fi

          if [ "$CHANGED" = "true" ]; then
            git commit -m "chore: patch stremio-addon-sdk -> latest and generate package-lock (via workflow)" || true
            git push origin HEAD:${{ github.ref_name }}
            echo "Committed and pushed changes."
          else
            echo "No changes to commit."
          fi